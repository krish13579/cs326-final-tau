<html>

<head>
    <meta charset="UTF-8">
    <title>Find Riders Page</title>
    <link href="/public/assets/findRiders.css" rel="stylesheet" type="text/css" />
    <script type="module" src="findRiders.js" defer></script>

</head>

<body>
    <div class="container">
        <div class="content">
            <header><u>Find Riders</u></header>
            <div class="owcontainer">
                <div class="Availble-rides">
                    <header>Requested Rides</header>
                    <div id="reqRides"></div>
                </div>
                <div class="Request">
                    <header>Create a Ride!</header>
                    <input placeholder="From Location" id="from" />
                    <input placeholder="To Location" id="to" />
                    <input placeholder="Date" id="date" type="date" />
                    <input placeholder="Number of Seats" id="numSeats" type="number" />
                    <input placeholder="Price per Seat ($)" id="ppseats" type="number" />
                    <br><br>
                    <button class="myButton2" id="sub">Submit</button>
                </div>
            </div>
        </div>
        <div class="article">
            <table>
                <tbody>
                    <tr>
                        <td>
                            <header>Ride Buddy.</header>
                        </td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td><button class="myButton" id="fd">Find Drivers</button></td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td><button class="myButton" id="fr">Find Riders</button></td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td><button class="myButton" id="yr">Your Rides</button></td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td><button class="myButton" id="mess">Messages</button></td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td><button class="myButton" id="yp">Your Profile</button></td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td><button class="myButton" id="lo">Log Out</button></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <script>
        document.getElementById("fd").addEventListener("click", () => {
            window.location.href = "/views/pages/Find Drivers Page/findDrivers";
        });
        document.getElementById("fr").addEventListener("click", () => {
            window.location.href = "/views/pages/Find Riders Page/findRiders";
        });
        document.getElementById("yr").addEventListener("click", () => {
            window.location.href = "/views/pages/Your Rides Page/yourRides";
        });
        document.getElementById("mess").addEventListener("click", () => {
            window.location.href = "/views/pages/Messages Page/messages";
        });
        document.getElementById("yp").addEventListener("click", () => {
            window.location.href = "/views/pages/Your Profile Page/profile";
        });
        document.getElementById("lo").addEventListener("click", () => {
            window.location.href = "/views/pages/logIn Page/login";
        });
        document.getElementById("sub").addEventListener("click", () => {
            validateInfo();
        });
        
        const userName = JSON.parse(window.localStorage.getItem("userName"));
        console.log(userName);
        // let userInformation = {};
        // async function getUserServerCall(nReq) {
        //     let response = await fetch('/getUserInformation', {
        //         method: 'POST',
        //         body: JSON.stringify(nReq),
        //         headers: {
        //             'Content-type': 'application/json; charset=UTF-8',
        //         }
        //     });
            
        //     if (response.ok) {
        //         let response2 = await response.json();
        //         userInformation = JSON.parse(JSON.stringify(response2));
        //     } 
        //     else {
        //         alert("Request failed");
        //     }
        // }
        // getUserServerCall({email: userName});

        window.onload = init;
        function init() {

            getData();

        }

        async function getData() {

            let responseR = await fetch('/getAllRequestedRides');
            if (responseR.ok) {
                let response2 = await responseR.json();
                console.log("response converted")
                console.log(response2);
                let riderData = response2;
                console.log("Sending to populate")
                populate(riderData);

            } else {
                alert("error getting data from server")
            }


        }

        function populate(rd) {

            let mainDiv = document.getElementById("reqRides");
            let rider = document.createElement("div");
            rider.classList.add("riderHeading");
            rider.textContent = "";
            rider.id = "rider";
            mainDiv.append(rider);
            let rideData = rd;

            for (let i = 0; i < rideData.length; ++i) {
                let temp = document.createElement("div");
                temp.classList.add("rider");
                let entrya = rideData[i];
                console.log("inside populate");
                console.log(entry);
                temp.textContent = "Origin: " + entry.origin + " To: " + entry.destination + " Date: " + entry.date + " Price: " + entry.price + " Seats: " + entry.numOfSeats;
                rider.append(temp);
            }
        }
        function validateInfo() {

            let from = document.getElementById("from").value;
            let to = document.getElementById("to").value;
            let date = document.getElementById("date").value;
            let seats = document.getElementById("numSeats").value;
            let price = document.getElementById("ppseats").value;

            if (from.length === 0 || to.length === 0 || date.length === 0 || price === null || seats === null) {
                alert("All required fields are not filled out");
                return;
            }

            let newRideObject = {
                // Constant Integer
                "rideID" : Math.random(),
                // Constant String
                "creator" : userName,
                // Boolean = Request or Offered
                "type" : "Offered",
                // Constant String
                "origin": from, 
                // Constant String
                "destination": to, 
                // Constant Date Object
                "date": date, 
                // Constant Integer
                "price": price,
                // Dynamic Integer
                "numOfSeats" : seats,
                // Dynamic Array
                "bookedUsers" : []
            };

            console.log(newRideObject);
            sendServer(userObject);

        }
        async function sendServer(nReq) {

            let response = await fetch('/createRide', {
                method: 'POST',
                body: JSON.stringify(nReq),
                headers: {
                    'Content-type': 'application/json; charset=UTF-8',
                }
            });

            if (response.ok) {
                let response2 = await response.json();
                alert("Your ride has been created!");

            } else {
                alert("Request failed");
            }
        }
    </script>
</body>

</html>
